<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Juice ‚Äî Crypto Escrow Challenges</title>

  <!-- Libraries -->
  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Ethers v6 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- WalletConnect (Required for the UGLY logic to work) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.0/dist/index.umd.js"></script>

  <!-- Styles -->
  <style>
    :root{
      --bg:#050608;
      --card:#16171b;
      --card-soft:#1c1d22;
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --border:#27272f;
      --accent:#00eaff;
      --accent-ink:#001014;
      --glow:0 0 12px rgba(0,234,255,0.65);
      --danger:#ef4444;
      --chip:#111114;
      --radius:18px;
      --fs:16px;
      --accent-green:#16a34a; /* same green you already use */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(circle at top,#111827 0,#020617 45%,#000 100%);
      color:var(--text);
      font:500 var(--fs)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }

    .app{
      max-width:960px;
      margin:0 auto;
      padding:20px 20px 24px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
      padding:0 16px;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      font-size:18px;
    }
    .brand-logo{
      width:24px;
      height:24px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      background:transparent;
      border:none;
      padding:0;
    }
    .brand-logo img{
      width:22px;
      height:22px;
      display:block;
    }

    /* Buttons / chips */
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:#101014;
      color:var(--text);
      padding:9px 16px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:background .12s ease,border-color .12s ease,transform .06s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      background:#18181b;
    }
    .btn.primary{
      background:#f9fafb;
      color:#020617;
      border-color:#f9fafb;
      font-weight:600;
    }
    .btn.primary:hover{
      background:#e5e7eb;
      border-color:#e5e7eb;
    }
    .btn.accent{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-ink);
      font-weight:600;
    }
    .btn.accent:hover{
      background:#16a34a;
      border-color:#16a34a;
    }
    .btn.ghost{
      border-color:var(--border);
      background:#101014;
      color:var(--text);
    }
    .btn.small{padding:6px 12px;font-size:13px}
    .btn.connected{
      border-color:var(--accent);
      color:var(--accent);
    }

    .chip{
      background:var(--chip);
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      font-size:11px;
      opacity:0.82;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .chip.badge{
      border-color:var(--accent);
      background:rgba(0,234,255,0.12);
      color:var(--accent);
      box-shadow:0 0 10px rgba(0,234,255,0.35);
      font-weight:500;
    }
    .chip.network-active{
      border-color:var(--accent); /* Blue border */
      color:var(--text); /* White text */
      background:var(--chip); /* Dark background (matches most button backgrounds) */
      box-shadow:var(--glow); /* Blue glow effect */
    }
    .chip a{
      color:inherit;
      text-decoration:none;
      white-space:nowrap;
    }
    .chip:active{
      background:var(--accent);
      color:var(--accent-ink);
      transition:background .15s ease,color .15s ease;
    }

    .subbar{
      display:flex;
      flex-direction:column;
      gap:4px;          /* was 8px */
      margin-bottom:2px;/* was 12px */
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
      padding:0 16px;
    }
    .addr{
      border-radius:999px;
      border:1px solid var(--accent);
      background:#0b0b10;
      padding:8px 18px;
      margin-bottom:10px;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;

      /* NEW ‚Äî clickable link styling */
      color:#ffffff !important;
      text-decoration:none !important;
      cursor:pointer;
    }
    .subchips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:space-between;
    }
    .subchips-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .chip{
      background:var(--chip);
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      font-size:11px;
      opacity:0.82;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
      cursor:default; /* will override below for clickable ones */
    }

    /* Add this immediately after the .chip block */
    .subchips .chip,
    .summary-card .chip{
      cursor:pointer;
    }

    .subchips .chip:hover,
    .summary-card .chip:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    /* Warning below status */
    .network-warning-bar{
      margin:0px auto 10px;   /* slightly closer to chips & tabs */
      font-size:12px;
      color:var(--muted);
      min-height:16px;
      text-align:center;
      max-width:520px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      background:#050509;
      border-radius:999px;
      border:1px solid var(--accent);
      padding:4px;
      margin:18px auto 24px;
      max-width:520px;
    }
    .tab{
      flex:1;
      border-radius:999px;
      border:none;
      background:transparent;
      color:var(--muted);
      padding:8px 0;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:background .12s ease,color .12s ease;
    }
    .tab.active{
      background:#f9fafb;
      color:#020617;
      font-weight:600;
      border:1px solid var(--accent);
    }

    .panel{display:none}
    .panel.active{display:block}

    /* Card */
    .card{
      border-radius:24px;
      background:var(--card);
      border:1px solid var(--border);
      padding:24px 24px 22px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      max-width:520px;
      margin:0 auto 16px;
    }
    .card-header{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:18px;
    }
    .card-title{
      font-size:20px;
      font-weight:600;
      text-align:center;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin-bottom:14px;
    }
    #resolveNote{
      text-align:center;
      width:100%;
      margin-bottom:20px;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }
    .input{
      width:100%;
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:var(--text);
      padding:10px 14px;
      font-size:14px;
    }
    .input::placeholder{color:#52525b}

    .row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .row.wrap{flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:10px}

    /* Idea bar */
    .idea-row{
      position:relative;
      margin-bottom:18px;
    }
    .idea-input{
      width:100%;
      border-radius:18px;
      border:1px solid #27272f;
      background:#26262a;
      color:var(--text);
      padding:12px 48px 12px 16px;
      font-size:14px;
    }
    .idea-dice{
      position:absolute;
      top:50%;
      right:10px;
      transform:translateY(-50%);
      width:32px;
      height:32px;
      border-radius:10px;
      border:2px solid #18DCF1;
      background:#101014;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:18px;
    }
    .idea-dice:hover{background:#18181b}

        /* Stake Area */
    .stake-area{
      margin-top:18px;
      margin-bottom:20px;
      text-align:left;  /* align with Join / Resolve labels */
    }
        .stake-label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
      text-align:left;  /* same alignment as other section labels */
    }
    .stake-main{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:24px;
      margin:16px 0 10px;
    }
    .stake-adjust,
    .stake-toggle{
      margin-left:auto;
    }
    .stake-symbol{
      font-size:32px;
      color:var(--muted);
      min-width:24px;
      text-align:right;
    }
    .stake-amount{
      font-size:48px;
      font-weight:700;
      min-width:0;
      width:160px;
      text-align:center;
      border:none;
      outline:none;
      background:transparent;
      color:#f9fafb;
      letter-spacing:-0.02em;
      line-height:1.05;
    }

    /* Hide number input arrows */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    input[type="number"]{-moz-appearance:textfield}

    /* Stake box */
    .stake-box{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:200px;
      padding:10px 12px;
      border:1px solid #2a2a2f;
      border-radius:18px;
      background:#1a1a1d;
      box-shadow:0 2px 6px rgba(0,0,0,0.28);
    }
    .stake-box .stake-symbol{
      font-size:22px;
      flex-shrink:0;
      color:#e4e4e7;
    }
    .stake-box .stake-amount{
      width:90px;
      max-width:90px;
      font-size:26px;
      text-align:center;
      border:none;
      background:transparent;
      color:#f9fafb;
      line-height:1.1;
    }

    .stake-toggle{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stake-toggle button{
      width:118px;
      text-align:center;
      background:#26262a;
      border-radius:10px;
      border:1px solid #26262a;
      padding:8px 0;
      font-size:11px;
      font-weight:700;
      color:#e4e4e7;
      cursor:pointer;
    }
    .stake-toggle button.connected{
      border:2px solid #18DCF1;
      background:#111827;
      color:#f9fafb;
    }

    .quick-row{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-top:10px;
      width:100%;
    }
    .quick-chip{
      border-radius:24px;
      border:1px solid #26262a;
      background:#26262a;
      color:#e4e4e7;
      padding:12px 0;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      white-space:nowrap;
    }
    .quick-chip:hover{
      background:#323238;
      border-color:#323238;
    }
    .deadline-input{
      border-radius:24px;
      border:2px solid #18DCF1;
      background:#101014;
      color:#e4e4e7;
      padding:12px 0;
      font-size:13px;
      text-align:center;
    }
    .amount-row{
      display:flex;
      gap:12px;
      justify-content:center;
      margin:14px 0 20px;
    }
    .quick-amt{
      flex:1;
      min-width:0;
      border-radius:20px;
      border:1px solid #2a2a2f;
      background:#1a1a1d;
      padding:14px 0;
      font-size:15px;
      font-weight:500;
      color:#e4e4e7;
      text-align:center;
      cursor:pointer;
      transition:.15s ease;
    }
    .quick-amt:hover{
      background:#26262b;
      border-color:#323238;
    }

    .stake-adjust{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-right:16px;
    }
    .adjust-btn{
      border-radius:12px;
      border:2px solid #18DCF1;
      background:#0b0b10;
      color:#18DCF1;
      font-size:18px;
      width:38px;
      height:28px;
      font-weight:600;
      cursor:pointer;
    }
    .adjust-btn:hover{
      background:#18DCF1;
      color:#0b0b10;
    }

    .footer-note{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
      text-align:right;
    }
    .status{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      min-height:16px;
    }

    /* Join Panel */
    .join-input-row{margin-bottom:10px}
    .btn-clear{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      color:#e4e4e7;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .resolve-section{
      margin-top:16px;
      padding-top:12px;
      border-top:1px solid #27272f;
    }
    .resolve-title{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      margin-bottom:4px;
    }
    .resolve-sub{
      font-size:11px;
      color:#71717a;
      text-align:center;
      margin-bottom:10px;
    }
    .vote-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:12px;
    }
    .vote-column-title{
      font-size:11px;
      color:#a1a1aa;
      text-align:center;
      margin-bottom:6px;
    }
    .vote-buttons{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* Share Section */
    .share-card{
      margin-top:14px;
      border-radius:18px;
      background:var(--card-soft);
      border:1px solid var(--border);
      padding:14px 16px 16px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
    }
    .share-title{
      font-size:13px;
      font-weight:500;
      margin-bottom:4px;
    }
    .share-help{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .qr-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:center;
    }
    .qr-box{
      border-radius:18px;
      border:1px solid #27272f;
      background:#050507;
      width:140px;
      height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }

    /* Summary Footer */
    .summary-card{
      margin-top:16px;
      border-radius:18px;
      background:#08080b;
      border:1px solid #27272f;
      padding:10px 16px;
      font-size:12px;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
    }
    .summary-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:6px;
      flex-wrap:wrap;
    }
    .state-pill{
      border-radius:999px;
      border:1px solid #27272f;
      background:#101014;
      padding:4px 10px;
      font-size:11px;
      color:var(--muted);
    }
    .state-pill.ok{
      border-color:var(--accent);
      color:var(--accent);
      background:#022c22;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .summary-label{color:#a1a1aa}
    .summary-value{font-weight:500}
    .summary-link{
      font-size:11px;
      color:#a1a1aa;
      text-decoration:underline;
    }
    .help-line{
      font-size:11px;
      color:#71717a;
      margin-top:4px;
      text-align:center;
      width:100%;
    }
    #sbPotEth,#sbPotUsd,#sbWinEth,#sbWinUsd{color:#18DCF1}

    #panelCreate .card-header,
    #panelCreate .card-sub{
      display:none;
    }

    #btnReset{
      border:1px solid var(--danger);
      color:var(--danger);
      background:#101014;
    }
    #btnReset:hover{
      background:var(--danger);
      color:#020617;
    }

    /* Site Footer */
    .site-footer{
      max-width:520px;
      margin:32px auto 40px;
      padding:14px 20px;
      font-size:11px;
      color:var(--muted);
      background:var(--card);
      border-radius:24px;
      border:1px solid var(--border);
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .site-footer nav{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .site-footer a{
      color:var(--muted);
      text-decoration:none;
      font-size:11px;
    }
    .site-footer a:hover{text-decoration:underline}
        /* Highlighted deadline inputs (15 and 30) */
    .deadline-highlight{
      background:#ffffff !important;  
      color:#000000 !important;
      border:2px solid var(--accent) !important; /* BLUE outline */
      border-radius:40px !important;
    }
    .deadline-highlight:focus{
      background:#ffffff !important;
      color:#000000 !important;
      border-color:var(--accent) !important; /* BLUE on focus */
    }
    /* ---------- ERROR MODAL ---------- */
    .error-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .error-modal.visible{
      display:flex;
    }
    .error-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.65);
    }
    .error-modal-card{
      position:relative;
      max-width:360px;
      width:90%;
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(0,0,0,.7);
      padding:18px 18px 16px;
      z-index:41;
    }
    .error-modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      margin-bottom:8px;
    }
    .error-modal-close{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:16px;
      padding:2px 4px;
    }
    .error-modal-close:hover{
      color:var(--text);
    }
    .error-modal-body{
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
      margin-top:4px;
    }
/* ---------- END MODAL ---------- */

    @media(max-width:640px){
        /* HEADER LAYOUT ON MOBILE */
    .topbar{
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      gap:6px;
      padding:0 8px;
      width:100%;
    }

    .top-actions{
      display:flex;
      flex-direction:row;
      flex-wrap:wrap;        /* allow a clean wrap if needed */
      justify-content:flex-start;
      align-items:center;
      gap:6px;
      width:100%;
    }

    .top-actions .btn{
      padding:4px 10px;
      font-size:11px;
      white-space:nowrap;
      flex-shrink:1;
    }
        /* Smaller, multiline contract pill on mobile */
    .addr{
      font-size:10px;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.3;
      padding:6px 10px;

      /* NEW ‚Äî clickable link styling */
      color:#ffffff !important;
      text-decoration:none !important;
      cursor:pointer;
    }

    /* keep the rest of your existing mobile rules below this */
    .app{
      padding:14px 12px 28px;
    }
    .card{
      padding:16px;
    }
    /* One-line layout for network / fee / contract chips on mobile */
    .subbar{
      padding:0 8px;
    }

    .subchips{
      display:flex;
      flex-direction:row;   /* all on one row */
      flex-wrap:nowrap;     /* don't wrap */
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .subchips-left{
      display:flex;
      flex-direction:row;   /* row instead of column */
      flex-wrap:nowrap;
      align-items:center;
      width:auto;           /* let content size itself */
    }

    .subchips .chip{
      width:auto;           /* no full-width chips */
      margin-bottom:0;
      padding:4px 8px;      /* smaller for mobile */
      font-size:10px;
      white-space:nowrap;   /* keep labels on one line */
      justify-content:center;
    }
    .quick-row{
      grid-template-columns:repeat(2,minmax(0,1fr));
    }
    .stake-amount{
      font-size:28px;
      min-width:80px;
    }
    .stake-main{
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      gap:12px;
    }
    .stake-box{
      width:210px;
      padding:8px 12px;
      border-radius:18px;
    }
    .stake-box .stake-symbol{
    font-size:22px;
    }
    .stake-box .stake-amount{
      width:100px;
      max-width:100px;
      font-size:24px;
    }
    .stake-adjust{
      margin-right:0;
    }
    .stake-adjust,
    .stake-toggle{
      margin-left:0;
    }
    .stake-toggle{
      flex-direction:row;
      justify-content:center;
      width:100%;
      gap:8px;
    }
    .stake-toggle button{
      flex:1;
      max-width:120px;
    }
    .site-footer{
      flex-direction:row;
      align-items:center;
      justify-content:space-between;
      text-align:left;
      padding:12px 16px;
      margin:24px auto 32px;
    }
    .site-footer nav{
      display:flex;
       flex-direction:row;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .site-footer a{
      margin:0;
    }
  }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-logo">
        <img src="favicon.png" alt="The Juice logo" onerror="this.style.display='none'"/>
      </div>
      <span>The Juice</span>
    </div>
    <div class="top-actions">
      <button id="btnSwitch" class="btn small ghost">Switch network</button>
      <button id="btnConnect" class="btn small ghost" onclick="connect()">Connect Wallet</button>
      <button id="btnWalletConnect" class="btn small ghost">Wallet Connect</button>
    </div>
  </header>

  <div class="subbar">
    <a id="addrPill"
       class="addr"
       title="View verified contract on Basescan"
       target="_blank"
       rel="noopener noreferrer">
    </a>
  </div>
  <div id="networkWarning" class="network-warning-bar">
    ‚ö†Ô∏è Base Mainnet ‚Äî Real ETH. Start with small stakes.
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabCreate" class="tab active">Create Challenge</button>
    <button id="tabJoin" class="tab">Join &amp; Resolve</button>
  </div>

  <!-- Create panel -->
  <div id="panelCreate" class="panel active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">Create Challenge</div>
      </div>
      <div class="card-sub">Set the Challenge, deadlines, and fund the escrow in one step.</div>

      <!-- Idea text bar -->
      <div class="idea-row">
        <input id="ideaBox" class="idea-input" type="text" value="Click üé≤ to generate a random challenge idea!"/>
        <button id="btnShuffle" class="idea-dice" aria-label="Random bet idea">üé≤</button>
      </div>

      <!-- Stake area -->
      <div class="stake-area">
        <div class="stake-label">Challenge Amount</div>
        <div class="stake-main">
          <div class="stake-box">
            <span id="stakeSymbol" class="stake-symbol">$</span>
            <input id="stakeMain" class="stake-amount" type="number" value="5"/>
          </div>

          <div class="stake-adjust">
            <button id="ethMinus" class="adjust-btn">‚àí</button>
            <button id="ethPlus" class="adjust-btn">+</button>
          </div>
          <div class="stake-toggle">
            <button id="stakeModeEth">ETH</button>
            <button id="stakeModeUsd" class="connected">USD</button>
          </div>
        </div>

        <!-- Hidden inputs from UGLY logic (Required) -->
        <input id="stakeEth" type="hidden" value="0.0014"/>
        <input id="stakeUsd" type="hidden" value="5"/>

        <div class="quick-row amount-row">
          <button id="usd1" class="quick-amt">$1</button>
          <button id="usd5" class="quick-amt">$5</button>
          <button id="usd10" class="quick-amt">$10</button>
          <button id="usd20" class="quick-amt">$20</button>
        </div>
      </div>

      <!-- Join deadline -->
      <div style="margin-top:14px">
        <div class="label">Join Deadline</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-join="15">15m</button>
            <button class="quick-chip" data-join="60">1h</button>
            <button class="quick-chip" data-join="1440">1 Day</button>
             <input
              id="joinMins"
              class="input deadline-input deadline-highlight"
              type="number"
              min="1"
              max="43200"
              value="15"
            />
          </div>
        </div>
      </div>

      <!-- Resolve deadline -->
      <div style="margin-top:12px">
        <div class="label">Resolve deadline</div>
        <div class="row wrap">
          <div class="quick-row">
            <button class="quick-chip" data-resolve="30">+30m</button>
            <button class="quick-chip" data-resolve="120">+2h</button>
            <button class="quick-chip" data-resolve="2880">+2 Days</button>
            <input
              id="resolveMins"
              class="input deadline-input deadline-highlight"
              type="number"
              min="30"
              max="43200"
              value="30"
            />
          </div>
        </div>
      </div>

      <div class="footer-note" id="usdNote">USD values are estimates only.</div>

      <!-- Actions -->
      <div class="row" style="margin-top:16px;gap:10px">
        <button id="btnCreate" class="btn accent" style="flex:1">Create &amp; Fund</button>
        <button id="btnReset" class="btn" style="min-width:90px">Reset</button>
      </div>

      <div id="createStatus" class="status"></div>
    </div>
  </div>

  <!-- Join / Resolve panel -->
  <div id="panelJoin" class="panel">
    <div class="card">
      <div id="resolveNote" class="card-sub">Paste a Challenge ID to join, refund, or finalize.</div>

      <!-- Challenge ID -->
      <div class="join-input-row row">
        <input id="betId" class="input join-input" placeholder="Paste Challenge ID‚Ä¶"/>
        <button class="btn-clear" onclick="document.getElementById('betId').value=''">Clear</button>
      </div>

      <!-- Join / refund -->
      <div class="stack" style="margin-top:8px">
        <button id="btnJoin" class="btn primary" style="width:100%">Join Challenge</button>
        <button id="btnRefund" class="btn ghost" style="width:100%">Request Refund</button>
      </div>

            <!-- Resolve winner -->
      <div class="resolve-section">
        <div class="resolve-title">Resolve winner</div>
        <div class="resolve-sub">
          Each player only sees their own vote. If both pick the same winner, payout is automatic.
        </div>

        <div class="vote-buttons">
          <button id="btnIWon" class="btn ghost" style="width:100%">I Won</button>
          <button id="btnILost" class="btn ghost" style="width:100%">Opponent Won</button>
        </div>

        <button id="btnPayout" class="btn accent" style="width:100%;margin-top:6px">
          Finalize &amp; Payout
        </button>
      </div>

      <div id="actionStatus" class="status"></div>
      <div id="newBetNote" class="status" style="text-align:center;display:none">üÜï New Challenge link prepared ‚Äî share the QR!</div>
    </div>

    <!-- Share / QR -->
    <div class="share-card">
      <div class="share-title">Share link &amp; QR</div>
      <div class="share-help">Send this link or QR to your opponent so they open the exact Challenge</div>

      <div class="qr-row">
        <div class="stack" style="flex:1;min-width:200px">
          <input id="shareUrl" class="input" readonly/>
          <div class="row wrap" style="gap:8px">
            <button id="btnCopyLink" class="btn small ghost" style="flex:1">Copy link</button>
            <button id="btnCopyId" class="btn small ghost" style="flex:1">Copy ID</button>
            <button id="btnNewBet" class="btn small ghost" style="flex:1">New</button>
          </div>
        </div>
        <div class="qr-box" id="qrBox"></div>
      </div>
    </div>
  </div>

  <!-- Summary footer -->
  <div class="summary-card">
    <div class="summary-top">
      <div id="sbState" class="state-pill">Not connected</div>
      <div id="chipFeeBottom" class="chip badge">Fee 2.5%</div>
      <div id="chipNetworkBottom" class="chip">Base ‚Ä¢ Mainnet ‚Ä¢ (8453)</div>
    </div>
    <div class="summary-row">
      <span class="summary-label">Pot value</span>
      <span class="summary-value"><span id="sbPotEth">0.0000</span> ETH (<span id="sbPotUsd">$0.00</span>)</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Winner gets</span>
      <span class="summary-value"><span id="sbWinEth">0.0000</span> ETH (<span id="sbWinUsd">$0.00</span>)</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Fee</span>
      <span class="summary-value">
        <span class="badge">Fee 2.5%</span>
      </span>
    </div>
    <div class="summary-row" style="margin-top:6px">
      <span class="summary-label">Last transaction</span>
      <a id="lastTx" class="summary-link" href="#" target="_blank" rel="noopener">View on Basescan</a>
    </div>
    <div class="help-line">Refunds are fee-free if deadlines pass.</div>
  </div>

    <footer class="site-footer">
    <div>¬© <span id="yearNow"></span> The Juice Labs</div>
    <nav>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
      <a href="risk.html">Risk</a>
    </nav>
  </footer>

  <!-- Error modal -->
  <div id="errorModal" class="error-modal">
    <div class="error-modal-backdrop" onclick="closeErrorModal()"></div>
    <div class="error-modal-card">
      <div class="error-modal-header">
        <span>Error</span>
        <button type="button"
                class="error-modal-close"
                onclick="closeErrorModal()">‚úï</button>
      </div>
      <div id="errorModalMessage" class="error-modal-body"></div>
      <button type="button"
              class="btn accent"
              style="width:100%;margin-top:12px"
              onclick="closeErrorModal()">
        Got it
      </button>
    </div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const NETWORKS = {
  mainnet:{
    key:'mainnet',
    label:'Base ‚Ä¢ Mainnet ‚Ä¢ (8453)',
    chainName:'Base Mainnet',
    idHex:'0x2105',
    rpc:'https://mainnet.base.org',
    explorer:'https://basescan.org',
    contract:'0x61eD264AAEF359717B2070E0426B26aa27D54890',
    warning:'‚ö†Ô∏è Base Mainnet ‚Äî Real ETH. Start with small stakes.'
  },
  testnet:{
    key:'testnet',
    label:'Base ‚Ä¢ Testnet ‚Ä¢ (84532)',
    chainName:'Base Sepolia',
    idHex:'0x14A34',
    rpc:'https://sepolia.base.org',
    explorer:'https://sepolia.basescan.org',
    contract:'0xD251F4aFB44Fa54Af8E714C8219d5a535Bc59433',
    warning:'üß™ Base Sepolia ‚Äî Test ETH only.'
  }
};

let CURRENT_NETWORK = 'mainnet';

const FEE_BPS = 250;
let ETH_USD = 3500;

async function refreshEthUsd(){
  try{
    const res = await fetch('https://api.coinbase.com/v2/prices/ETH-USD/spot');
    const data = await res.json();
    const price = parseFloat(data?.data?.amount);
    if(!isNaN(price) && price>0){
      ETH_USD = price;
      const note = $('usdNote');
      if(note){
        note.textContent = `USD values use ETH ‚âà $${price.toFixed(2)} (preview only).`;
      }
      updatePreview();
      return;
    }
  }catch(e){}
  const note = $('usdNote');
  if(note){
    note.textContent = 'USD values are estimates only and may be outdated.';
  }
}

function currentBase(){return NETWORKS[CURRENT_NETWORK];}
function currentContract(){return currentBase().contract;}

/* ---------- Network UI helpers ---------- */
function applyNetworkUI(){
  const net = currentBase();

  const chipTop = $('chipNetwork');
  if(chipTop) chipTop.textContent = net.label;

  const chipBottom = $('chipNetworkBottom');
  if(chipBottom) chipBottom.textContent = net.label;

  const warning = $('networkWarning');
  if(warning) warning.textContent = net.warning;

  const addr = $('addrPill');
  if (addr) {
    addr.textContent = `Contract: ${currentContract()}`;
    addr.href = `${net.explorer}/address/${currentContract()}#code`;
  }

  const switchBtn = $('btnSwitch');
  if(switchBtn){
    switchBtn.textContent = (CURRENT_NETWORK==='mainnet')
      ? 'Use Base Sepolia'
      : 'Use Base Mainnet';
  }
  updateWalletNetworkLabel();
}

async function updateWalletNetworkLabel(){
  const el = $('sbWalletNet');
  if(!el) return;

  if(!provider){
    el.textContent = 'Wallet: not connected';
    return;
  }

  try{
    const net = await provider.getNetwork();
    const chainId = Number(net.chainId.toString());

    let label;
    if(chainId===8453){
      label = 'Wallet: Base Mainnet (8453)';
    }else if(chainId===84532){
      label = 'Wallet: Base Sepolia (84532)';
    }else{
      label = `Wallet: chainId ${chainId}`;
    }

    el.textContent = label;

    const chipTop = $('chipNetwork');
    const chipBottom = $('chipNetworkBottom');
    chipTop?.classList.remove('network-active');
    chipBottom?.classList.remove('network-active');

    if(chainId===8453 && CURRENT_NETWORK==='mainnet'){
      chipTop?.classList.add('network-active');
      chipBottom?.classList.add('network-active');
    }
    if(chainId===84532 && CURRENT_NETWORK==='testnet'){
      chipTop?.classList.add('network-active');
      chipBottom?.classList.add('network-active');
    }
  }catch(e){
    console.error('updateWalletNetworkLabel failed',e);
    el.textContent = 'Wallet: unknown network';
  }
}

async function toggleNetwork(){
  CURRENT_NETWORK = (CURRENT_NETWORK==='mainnet') ? 'testnet' : 'mainnet';
  applyNetworkUI();
  try{
    await ensureBase();
  }catch(e){
    console.error('Network switch canceled or failed',e);
  }
}

/* ---------- Shortcuts ---------- */
const $ = id => document.getElementById(id);
const fmtUsd = v => '$' + v.toFixed(2);

/* ---------- Error modal helpers ---------- */
function openErrorModal(message){
  const modal = $('errorModal');
  const msgEl = $('errorModalMessage');
  if (!modal || !msgEl) return;

  msgEl.textContent = message;
  modal.classList.add('visible');
}

function closeErrorModal(){
  const modal = $('errorModal');
  if (modal) modal.classList.remove('visible');
}

/**
 * Show an error in the inline status area AND in the popup.
 * targetId is "createStatus" or "actionStatus".
 */
function showError(message, targetId){
  if (targetId && $(targetId)){
    $(targetId).textContent = message;
  }
  openErrorModal(message);
}

/* ---------- QR + share helpers ---------- */
function currentShareUrl(){
  const betIdRaw = String(($('betId')?.value || '')).trim();
  const ideaRaw  = String(($('ideaBox')?.value || '')).trim();

  try{
    const u = new URL(location.href);
    if(/^\d+$/.test(betIdRaw)){
      u.searchParams.set('bet',betIdRaw);
    }else{
      u.searchParams.delete('bet');
    }
    if(ideaRaw){
      u.searchParams.set('idea',ideaRaw);
    }else{
      u.searchParams.delete('idea');
    }
    return u.toString();
  }catch{
    return location.href;
  }
}

let qr = null;
function renderQR(){
  const node = $('qrBox');
  if(!node) return;
  node.innerHTML = '';
  qr = new QRCode(node,{
    text:currentShareUrl(),
    width:140,
    height:140,
    colorDark:'#ffffff',
    colorLight:'#0b0b10',
    correctLevel:QRCode.CorrectLevel.M
  });
}
function setCopyPulse(el){
  el.classList.add('connected');
  setTimeout(()=>el.classList.remove('connected'),800);
}

/* ---------- USD/ETH preview ---------- */
function updatePreview(){
  const eth = parseFloat($('stakeEth').value || '0') || 0;
  const pot = eth*2;
  const win = pot*(1-FEE_BPS/10000);

  const potEthEl = $('sbPotEth');
  if(potEthEl) potEthEl.textContent = pot.toFixed(4);

  const potUsdEl = $('sbPotUsd');
  if(potUsdEl) potUsdEl.textContent = fmtUsd(pot*ETH_USD);

  const winEthEl = $('sbWinEth');
  if(winEthEl) winEthEl.textContent = win.toFixed(4);

  const winUsdEl = $('sbWinUsd');
  if(winUsdEl) winUsdEl.textContent = fmtUsd(win*ETH_USD);
}

/* Hidden fields kept in ETH and USD */
function applyStakeFromEth(rawEth){
  const eth = Math.max(0,Number(rawEth) || 0);
  $('stakeEth').value = eth.toFixed(4);
  $('stakeUsd').value = (eth*ETH_USD).toFixed(0);
  updatePreview();

  if(stakeMode==='ETH'){
    $('stakeSymbol').textContent = 'Œû';
    $('stakeMain').value = eth.toFixed(4);
  }else{
    $('stakeSymbol').textContent = '$';
    $('stakeMain').value = (eth*ETH_USD).toFixed(0);
  }
}

function applyStakeFromUsd(usd){
  const u = Math.max(0,Number(usd) || 0);
  $('stakeUsd').value = u.toFixed(0);
  const eth = (u/ETH_USD) || 0;
  $('stakeEth').value = eth.toFixed(4);
  updatePreview();

  if(stakeMode==='USD'){
    $('stakeSymbol').textContent = '$';
    $('stakeMain').value = u.toFixed(0);
  }else{
    $('stakeSymbol').textContent = 'Œû';
    $('stakeMain').value = eth.toFixed(4);
  }
}

let stakeMode = 'USD';
function setStakeMode(mode){
  stakeMode = mode;
  if(mode==='ETH'){
    $('stakeModeEth').classList.add('connected');
    $('stakeModeUsd').classList.remove('connected');
    $('stakeSymbol').textContent = 'Œû';
    $('stakeMain').value = Number($('stakeEth').value || '0').toFixed(4);
  }else{
    $('stakeModeUsd').classList.add('connected');
    $('stakeModeEth').classList.remove('connected');
    $('stakeSymbol').textContent = '$';
    $('stakeMain').value = Number($('stakeUsd').value || '0').toFixed(0);
  }
}

/* ---------- Stake input wiring ---------- */
function handleStakeMainInput(){
  const raw = $('stakeMain').value;
  if(stakeMode==='ETH'){
    applyStakeFromEth(raw);
  }else{
    applyStakeFromUsd(raw);
  }
}

/* ---------- Bet ideas ---------- */
const IDEAS = [
  "Basketball üèÄ : Make a 3-point shot from the top of the key",
  "Darts üéØ : Hit any double in 3 throws",
  "Darts üéØ : You vs Me",
  "Darts üéØ : Bullseye",
  "Drink ü•õ : Chug under 1 minute",
  "Hockey ü•Ö : Hit the crossbar",
  "Lacrosse ü•ç : Top right corner",
  "Human ü•á : No way!",
  "Human ü•á : I bet you can't",
  "Cornhole ü•á : 2 in a row",
  "Bottle Flip üçº : 3 out of 5",
  "Soccer ‚öΩÔ∏è : Crossbar in 3 tries",
  "Golf ‚õ≥Ô∏è : Hole in one!",
  "Golf üèåÔ∏è‚Äç‚ôÇÔ∏è : 3-putt?",
  "Golf üèåÔ∏è‚Äç‚ôÇÔ∏è : 2-putt or better",
  "Golf üèåÔ∏è‚Äç‚ôÇÔ∏è : Long-drive contest",
  "Golf üèåÔ∏è‚Äç‚ôÇÔ∏è : Closest to the pin",
  "Ping pong üèì : Race to 11",
  "ü•Ö First to 3 goals ü•Ö",
  "Next hole ‚õ≥Ô∏è : low score wins",
  "Basketball üèÄ : Next free throw üèÄ",
  "BasketBall ‚õπÔ∏è : You vs me",
  "üèà Next field goal attempt üèà",
  "‚öΩÔ∏è Penalty kick showdown ‚öΩÔ∏è",
  "üí∞ Coin flip, best of 3",
  "‚úÇÔ∏è Rock‚Äìpaper‚Äìscissors üóíÔ∏è",
  "Dice üé≤",
  "Bowling üé≥ : Perfect Game",
  "Bowling üé≥ : You vs me",
  "Chess ‚ôüÔ∏è : You vs me",
  "Video Game üéÆ : You vs me",
  "Pool üé± : Team 1 vs Team 2",
  "Ping Pong üèì : You vs me",
  "Badminton üè∏ : Team 1 vs Team 2",
  "Tennis üéæ : Team 1 vs Team 2",
  "Volleyball üèê : Team 1 vs Team 2",
  "Baseball ‚öæÔ∏è : Team 1 vs Team 2",
  "Softball ü•é : Team 1 vs Team 2",
  "Archery üèπ : Best score"
];

function shuffleIdea(){
  const input = $('ideaBox');
  if(!input) return;
  const idx = Math.floor(Math.random()*IDEAS.length);
  input.value = IDEAS[idx];
}

/* ---------- New challenge link ---------- */
function startNewBet(){
  $('newBetNote').style.display = 'none';
  $('betId').value = '';
  $('ideaBox').value = '';
  const url = currentShareUrl();
  $('shareUrl').value = url;
  renderQR();
}

/* ---------- ABI ---------- */
const ABI = [
  {type:'function',stateMutability:'payable',name:'openChallenge',
    inputs:[{type:'uint256'},{type:'uint16'},{type:'uint64'},{type:'uint64'}],outputs:[]},
  {type:'function',stateMutability:'payable',name:'joinChallenge',
    inputs:[{type:'uint256'}],outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'submitOutcomeVote',
    inputs:[{type:'uint256'},{type:'bool'}],outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'resolveChallenge',
    inputs:[{type:'uint256'}],outputs:[]},
  {type:'function',stateMutability:'nonpayable',name:'issueRefund',
    inputs:[{type:'uint256'}],outputs:[]},
  {type:'function',stateMutability:'view',name:'getChallenge',
    inputs:[{type:'uint256'}],
    outputs:[
      {type:'address'},{type:'address'},{type:'uint256'},{type:'uint16'},
      {type:'uint64'},{type:'uint64'},{type:'uint64'},{type:'uint8'},
      {type:'int8'},{type:'int8'}
    ]},
  {type:'function',stateMutability:'view',name:'nextChallengeId',
    inputs:[],outputs:[{type:'uint256'}]}
];

/* ---------- Wallet / ethers ---------- */
let provider,signer;
let wcProvider = null;
const WC_PROJECT_ID = '0a7260b6b9e686ea7a8bcd57085eac0e';

function getEth(){
  const eth = window.ethereum;
  if(!eth) return null;
  if(eth.providers && eth.providers.length){
    const mm = eth.providers.find(p=>p.isMetaMask);
    return mm || eth.providers[0];
  }
  return eth;
}

async function ensureBase(){
  const eth = getEth();
  if(!eth){
    alert('Wallet not found (MetaMask / Coinbase / Brave).');
    throw new Error('no wallet');
  }
  const chain = await eth.request({method:'eth_chainId'});
  if(chain!==currentBase().idHex){
    try{
      await eth.request({
        method:'wallet_switchEthereumChain',
        params:[{chainId:currentBase().idHex}]
      });
    }catch(e){
      if(e.code===4902){
        await eth.request({
          method:'wallet_addEthereumChain',
          params:[{
            chainId:currentBase().idHex,
            chainName:currentBase().chainName,
            nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18},
            rpcUrls:[currentBase().rpc],
            blockExplorerUrls:[currentBase().explorer]
          }]
        });
      }else{
        console.error('ensureBase() failed',e);
        throw e;
      }
    }
  }
}

async function connect(){
  try{
    await ensureBase();
    const eth = getEth();
    if(!eth){
      alert('Wallet not found (MetaMask / Coinbase / Brave).');
      throw new Error('no wallet');
    }
    await eth.request({method:'eth_requestAccounts'});

    provider = new ethers.BrowserProvider(eth);
    signer = await provider.getSigner();
    $('sbState').textContent = 'Connected';
    updateWalletNetworkLabel();

    const netChipTop = $('chipNetwork');
    const netChipBottom = $('chipNetworkBottom');
    if(netChipTop) netChipTop.classList.add('badge');
    if(netChipBottom) netChipBottom.classList.add('badge');

    $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');
    updateWalletNetworkLabel();

  }catch(e){
    console.error('connect() failed',e);
    $('sbState').textContent = 'Not connected';
    $('sbState').classList.remove('ok');
    const w = $('sbWalletNet');
    if(w) w.textContent = 'Wallet: not connected';
  }
}

async function ensureWalletOnChain(wcProvider,chainId){
  const chainIdHex = chainId===8453 ? '0x2105' : '0x14a34';
  const isMainnet = chainId===8453;

  try{
    await wcProvider.request({
      method:'wallet_switchEthereumChain',
      params:[{chainId:chainIdHex}]
    });
  }catch(err){
    const code = err.code || (err.data && err.data.originalError && err.data.originalError.code);
    if(code===4902){
      await wcProvider.request({
        method:'wallet_addEthereumChain',
        params:[{
          chainId:chainIdHex,
          chainName:isMainnet ? 'Base Mainnet' : 'Base Sepolia',
          nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},
          rpcUrls:[isMainnet ? 'https://mainnet.base.org' : 'https://sepolia.base.org'],
          blockExplorerUrls:[isMainnet ? 'https://basescan.org' : 'https://sepolia.basescan.org']
        }]
      });
    }else{
      console.error('wallet_switchEthereumChain failed',err);
      throw err;
    }
  }

  const walletChainHex = await wcProvider.request({method:'eth_chainId'});
  if(walletChainHex.toLowerCase()!==chainIdHex){
    throw new Error(`Wallet still not on expected chain ${chainIdHex}, got ${walletChainHex}`);
  }
}

async function connectWithWalletConnect(){
  try{
    if(!WC_PROJECT_ID || WC_PROJECT_ID==='YOUR_PROJECT_ID_HERE'){
      alert('Add your WalletConnect project ID in WC_PROJECT_ID before using this.');
      return;
    }

    const net = currentBase();
    const chainId = net.key==='mainnet' ? 8453 : 84532;

    const wcModule = window['@walletconnect/ethereum-provider'] || window.WalletConnectEthereumProvider;
    const EthereumProvider = wcModule?.EthereumProvider || wcModule?.default || wcModule;

    if(!EthereumProvider || !EthereumProvider.init){
      console.error('WalletConnect provider not found.',wcModule);
      alert('WalletConnect library failed to load. Check the <script> tag in <head>.');
      return;
    }

    wcProvider = await EthereumProvider.init({
      projectId:WC_PROJECT_ID,
      chains:[chainId],
      showQrModal:true,
      metadata:{
        name:'The Juice',
        description:'Peer-to-peer crypto escrow challenges on Base',
        url:window.location.origin,
        icons:[window.location.origin + '/favicon.png'],
      },
    });

    await wcProvider.connect();
    await ensureWalletOnChain(wcProvider,chainId);

    provider = new ethers.BrowserProvider(wcProvider);
    signer   = await provider.getSigner();

    $('sbState').textContent = 'Connected (WalletConnect)';
    $('sbState').classList.add('ok');
    $('btnConnect').classList.add('connected');

    const netChipTop = $('chipNetwork');
    const netChipBottom = $('chipNetworkBottom');
    if(netChipTop) netChipTop.classList.add('badge');
    if(netChipBottom) netChipBottom.classList.add('badge');

    updateWalletNetworkLabel();
    applyNetworkUI();

  }catch(e){
    console.error('WalletConnect failed',e);
    $('sbState').textContent = 'WalletConnect failed or canceled';
    $('sbState').classList.remove('ok');
    const w = $('sbWalletNet');
    if(w) w.textContent = 'Wallet: not connected';
    if(wcProvider){
      wcProvider = null;
    }
  }
}

function getContract(){
  if(!signer) throw new Error('Connect your wallet first.');
  return new ethers.Contract(currentContract(),ABI,signer);
}

function requireBetId(){
  const raw = String(($('betId').value || '').trim());
  if(!raw) throw new Error('Enter a challenge ID first.');
  if(!/^\d+$/.test(raw)) throw new Error('Challenge ID must be a number.');
  return BigInt(raw);
}

/* ---------- Actions ---------- */
async function doCreate(){
  $('createStatus').textContent = 'Sending‚Ä¶';
  try{
    await ensureBase();
    if(!signer) await connect();
    const c = getContract();

    const stakeEthStr = String($('stakeEth').value || '0');
    const stakeEthNum = Number(stakeEthStr);
    if(!Number.isFinite(stakeEthNum) || stakeEthNum<=0){
      throw new Error('Stake must be greater than zero.');
    }

    let jm = Math.max(5,Math.min(43200,parseInt($('joinMins').value || '15',10)));
    let rm = Math.max(30,Math.min(43200,parseInt($('resolveMins').value || '30',10)));

    if(rm<=jm){
      throw new Error('Resolve deadline must be greater than join deadline.');
    }

    $('joinMins').value = jm;
    $('resolveMins').value = rm;

    const stakeWei = ethers.parseEther(stakeEthNum.toFixed(4));

    const tx = await c.openChallenge(
      stakeWei,
      FEE_BPS,
      BigInt(jm*60),
      BigInt(rm*60),
      {value:stakeWei}
    );

    $('createStatus').textContent = 'Pending ' + tx.hash;

    await tx.wait();
    $('lastTx').href = `${currentBase().explorer}/tx/${tx.hash}`;
    $('createStatus').textContent = '‚úÖ Challenge created';

    const nextId = await c.nextChallengeId();
    const betId = (BigInt(nextId) - 1n).toString();
    $('betId').value = betId;
    $('shareUrl').value = currentShareUrl();
    renderQR();
    $('newBetNote').style.display = 'block';

    const tabJoin = $('tabJoin');
    if(tabJoin) tabJoin.click();
  }catch(e){
    console.error('createBet error',e);
    showError('‚ùå ' + (e?.shortMessage || e?.message || e), 'createStatus');
  }
}

async function doJoin(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    await ensureBase();
    if(!signer) await connect();
    const c = getContract();
    const betId = requireBetId();

    const b = await c.getChallenge(betId);
    if(b[0]===ethers.ZeroAddress){
      showError('‚ùå Challenge not found', 'actionStatus');
      return;
    }

    const stakeWei = b[2];
    const state = Number(b[7]);
    if(state!==0){
      showError('‚ùå Challenge is not open to join', 'actionStatus');
      return;
    }

    const tx = await c.joinChallenge(betId,{value:stakeWei});
    await tx.wait();
    $('lastTx').href = `${currentBase().explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Joined challenge';
  }catch(e){
    showError('‚ùå ' + (e?.shortMessage || e?.message || e), 'actionStatus');
  }
}

  async function doVote(iWon){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    await ensureBase();
    if(!signer) await connect();
    const c = getContract();
    const betId = requireBetId();

    const b = await c.getChallenge(betId);
    if (b[0] === ethers.ZeroAddress){
      showError('‚ùå Challenge not found', 'actionStatus');
      return;
    }

    // Figure out who the caller is
    const caller   = (await signer.getAddress()).toLowerCase();
    const creator  = b[0].toLowerCase();
    const opponent = b[1].toLowerCase();

    if (caller !== creator && caller !== opponent){
      showError('‚ùå You are not part of this challenge', 'actionStatus');
      return;
    }

    // Convert "I won" into the contract's "creatorWon" flag
    // - If caller IS the creator, iWon === true  -> creatorWon = true
    // - If caller IS the opponent, iWon === true -> creatorWon = false
    let creatorWon;
    if (caller === creator){
      creatorWon = !!iWon;
    } else {
      creatorWon = !iWon;
    }

    const tx = await c.submitOutcomeVote(betId, creatorWon);
    await tx.wait();
    $('lastTx').href = `${currentBase().explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Vote submitted';
    }catch(e){
      showError('‚ùå ' + (e?.shortMessage || e?.message || e), 'actionStatus');
    }
  }

async function doRefund(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    await ensureBase();
    if(!signer) await connect();
    const c = getContract();
    const betId = requireBetId();

    const b = await c.getChallenge(betId);
    if(b[0]===ethers.ZeroAddress){
      showError('‚ùå Challenge not found', 'actionStatus');
      return;
    }

    const joinDeadline    = Number(b[4]);
    const resolveDeadline = Number(b[5]);
    const state           = Number(b[7]);
    const creatorVote     = Number(b[8]);
    const opponentVote    = Number(b[9]);

    const now = Math.floor(Date.now()/1000);

    const noOpponent   = (b[1]===ethers.ZeroAddress);
    const canSoloRefund   = (state===0 && noOpponent && now>joinDeadline);

    const votesSet       = (creatorVote!==-1 && opponentVote!==-1);
    const votesMismatch  = votesSet && (creatorVote!==opponentVote);
    const canSplitRefund = (state===1 && votesMismatch && now>resolveDeadline);

    if(!canSoloRefund && !canSplitRefund){
      showError('‚ùå Refund not available yet for this challenge', 'actionStatus');
      return;
    }

    const tx = await c.issueRefund(betId);
    await tx.wait();
    $('lastTx').href = `${currentBase().explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Refund sent';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage || e?.message || e);
  }
}

async function doPayout(){
  $('actionStatus').textContent = 'Sending‚Ä¶';
  try{
    await ensureBase();
    if(!signer) await connect();
    const c = getContract();
    const betId = requireBetId();
    const b = await c.getChallenge(betId);

    if(b[0]===ethers.ZeroAddress){
      showError('‚ùå Challenge not found', 'actionStatus');
      return;
    }

    const state        = Number(b[7]);
    const creatorVote  = Number(b[8]);
    const opponentVote = Number(b[9]);

    if(state!==1){
      showError('‚ùå Challenge is not in a resolvable state', 'actionStatus');
      return;
    }

    const votesSet   = (creatorVote!==-1 && opponentVote!==-1);
    const votesMatch = votesSet && (creatorVote===opponentVote);

    if(!votesMatch){
      showError('‚ùå Both sides must vote and agree before payout', 'actionStatus');
      return;
    }

    const tx = await c.resolveChallenge(betId);
    await tx.wait();
    $('lastTx').href = `${currentBase().explorer}/tx/${tx.hash}`;
    $('actionStatus').textContent = '‚úÖ Payout finalized';
  }catch(e){
    $('actionStatus').textContent = '‚ùå ' + (e?.shortMessage || e?.message || e);
  }
}

/* ---------- Wire UI ---------- */
window.addEventListener('DOMContentLoaded',()=>{
  applyNetworkUI();
  const btnSwitch = $('btnSwitch'); if(btnSwitch) btnSwitch.onclick = toggleNetwork;
  const btnWC = $('btnWalletConnect'); if(btnWC) btnWC.onclick = connectWithWalletConnect;

  applyStakeFromEth(0.0014);
  setStakeMode('USD');
  $('stakeMain').addEventListener('input',handleStakeMainInput);

  refreshEthUsd();

  $('stakeModeEth').onclick = ()=>setStakeMode('ETH');
  $('stakeModeUsd').onclick = ()=>setStakeMode('USD');

  $('usd1').onclick  = ()=>{setStakeMode('USD');$('stakeMain').value=1;handleStakeMainInput();};
  $('usd5').onclick  = ()=>{setStakeMode('USD');$('stakeMain').value=5;handleStakeMainInput();};
  $('usd10').onclick = ()=>{setStakeMode('USD');$('stakeMain').value=10;handleStakeMainInput();};
  $('usd20').onclick = ()=>{setStakeMode('USD');$('stakeMain').value=20;handleStakeMainInput();};

  $('ethPlus').onclick = ()=>{
    if(stakeMode==='ETH'){
      const v = Math.max(0,parseFloat($('stakeEth').value || '0') + 0.0001);
      applyStakeFromEth(v);
    }else{
      const usd = (Number($('stakeMain').value) || 0) + 1;
      $('stakeMain').value = usd;
      handleStakeMainInput();
    }
  };
  $('ethMinus').onclick = ()=>{
    if(stakeMode==='ETH'){
      const v = Math.max(0,parseFloat($('stakeEth').value || '0') - 0.0001);
      applyStakeFromEth(v);
    }else{
      const usd = Math.max(0,(Number($('stakeMain').value) || 0) - 1);
      $('stakeMain').value = usd;
      handleStakeMainInput();
    }
  };

  document.querySelectorAll('[data-join]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $('joinMins').value = btn.getAttribute('data-join');
    });
  });
  document.querySelectorAll('[data-resolve]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $('resolveMins').value = btn.getAttribute('data-resolve');
    });
  });

  $('btnCreate').onclick = doCreate;
  $('btnJoin').onclick   = doJoin;
  $('btnRefund').onclick = doRefund;
  $('btnPayout').onclick = doPayout;

    // Outcome voting: simple "I won" / "Opponent won" buttons
  const btnIWon  = $('btnIWon');
  const btnILost = $('btnILost');
  if (btnIWon)  btnIWon.onclick  = ()=> doVote(true);   // I Won
  if (btnILost) btnILost.onclick = ()=> doVote(false);  // Opponent Won

  $('btnShuffle').onclick = shuffleIdea;

  const btnReset = $('btnReset');
  if(btnReset){
    btnReset.onclick = ()=>{
      $('joinMins').value = '15';
      $('resolveMins').value = '30';
      applyStakeFromEth(0.0014);
      startNewBet();
    };
  }

  $('shareUrl').value = currentShareUrl();
  renderQR();

  $('btnCopyLink').onclick = ()=>{
    navigator.clipboard.writeText($('shareUrl').value || '').then(()=>{
      setCopyPulse($('btnCopyLink'));
    });
  };
  $('btnCopyId').onclick = ()=>{
    const id = String(($('betId').value || '').trim());
    if(!id){
      alert('No challenge ID to copy yet.');
      return;
    }
    navigator.clipboard.writeText(id).then(()=>{
      setCopyPulse($('btnCopyId'));
    });
  };
  $('btnNewBet').onclick = ()=>{
    startNewBet();
    setCopyPulse($('btnNewBet'));
  };

  const tabCreate   = $('tabCreate');
  const tabJoin     = $('tabJoin');
  const panelCreate = $('panelCreate');
  const panelJoin   = $('panelJoin');

  tabCreate.onclick = ()=>{
    tabCreate.classList.add('active');
    tabJoin.classList.remove('active');
    panelCreate.classList.add('active');
    panelJoin.classList.remove('active');
    if($('actionStatus')) $('actionStatus').textContent='';
  };

  tabJoin.onclick = ()=>{
    tabJoin.classList.add('active');
    tabCreate.classList.remove('active');
    panelJoin.classList.add('active');
    panelCreate.classList.remove('active');
    if($('createStatus')) $('createStatus').textContent='';
  };

  try{
    const u = new URL(location.href);
    const bet  = u.searchParams.get('bet');
    const idea = u.searchParams.get('idea');

    if(bet && /^\d+$/.test(bet)){
      $('betId').value = bet;
      $('shareUrl').value = currentShareUrl();
      renderQR();
      tabJoin.click();
    }
    if(idea){
      $('ideaBox').value = idea;
    }
  }catch(e){}

  const y = $('yearNow');
  if(y) y.textContent = String(new Date().getFullYear());

  if(window.ethereum?.on){
    window.ethereum.on('chainChanged',()=>{
      signer = null;
      $('sbState').textContent = 'Network changed ‚Äî reconnect';
      $('sbState').classList.remove('ok');
      $('btnConnect').classList.remove('connected');
    });
    window.ethereum.on('accountsChanged',()=>{
      signer = null;
      $('sbState').textContent = 'Account changed ‚Äî reconnect';
      $('sbState').classList.remove('ok');
      $('btnConnect').classList.remove('connected');
    });
  }
});
</script>
</body>
</html>
